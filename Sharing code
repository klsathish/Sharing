SP_AddActivityLogForAdmin	@ActivityType, @CreatedBy, @IdentityColID, @NewValue, @OldValue, @TableName
sp_AddWorkflowDelegation	@CreatedBy, @FromDate, @FromUserId, @IsEffective, @ProcessId, @ToDate, @ToUserId
sp_AddWorkflowRedirect	@AssignedDate, @Department, @PendingWithDesignate, @PendingWithId, @PendingWithName, @Reason, @RedirectedFrom, @RedirectedFromEmail, @RedirectedOn, @RedirectedTo, @RedirectedToEmail, @WorkflowNumber
SP_AddWorkRecommendationAction	@ActionBy, @ActionTaken, @Comments, @RequestNumber, @StageName
sp_alterdiagram	@definition, @diagramname, @owner_id, @version
SP_CreateCMLogicFORRecommendations	@BU, @CompanyCode, @FromDate, @ProfitCenterID, @SBU, @ToDate
sp_creatediagram	@definition, @diagramname, @owner_id, @version
sp_dropdiagram	@diagramname, @owner_id
SP_GetAffiliate	@CountryID
SP_GetAffiliateForUserManagement	NULL
SP_GetAllErrorLogging	@FromDate, @ToDate
SP_GetAllWorkRecommendations	@BU, @CompanyCode, @FromDate, @ProfitCenterID, @SBU, @ToDate
SP_GetAPIRequestLog	@FromDate, @ToDate
SP_GetAuthenticatedUserDetails	@Username
SP_GetAverageSellingPrice	@BU, @CompanyCode, @FromDate, @ProfitCenterID, @SBU, @ToDate, @TypeID
SP_GetBaseFilters	@CountryID, @RegionID, @RoleID, @TypeID
SP_GetCMRecommendations	@BU, @CompanyCode, @FromDate, @ProfitCenterID, @SBU, @ToDate
SP_GetCMRecommendationsDetailsByID	@RecommendationID
SP_GetCMRecommendationViewRegionData	@RecommendationID
SP_GetContributionMargin	@BU, @CompanyCode, @DateRange, @ProfitCenterID, @SBU, @TypeID
SP_GetContributionMarginCard	@BU, @CompanyCode, @FromDate, @ProfitCenterID, @SBU, @ToDate, @TypeID
SP_GetContributionMarginTrend	@BU, @CompanyCode, @FromDate, @ProfitCenterID, @SBU, @ToDate, @TypeID
SP_GetCountry	@RegionID
SP_GetDataForAuthenticationByUserId	@UserID
SP_GetErrorLog_AssignToUser	NULL
SP_GetErrorLogging	@ErrorMessage
SP_GetErrorLogStatus	NULL
SP_GetExceptionUserActivityDetailsBySessionID	@SessionID
SP_GetForecastRanges	NULL
SP_GetHistoricalSavings	@BU, @CompanyCode, @FromDate, @ProfitCenterID, @SBU, @ToDate, @TypeID
SP_GetLoginActivity	@FromDate, @ToDate
SP_GetLoginUserActivity	@FromDate, @ToDate
SP_GetMoreFiltersProfitCenter	@affiliateID, @profitCenterID
SP_GetMoreFiltersSBUandBU	@sbuID
SP_GetPerformanceLog	@FromDate, @ToDate
SP_GetProductionMapDetails	@BU, @CompanyCode, @FromDate, @ProfitCenterID, @SBU, @ToDate, @TypeID
SP_GetRecommendationDetails	@BU, @CompanyCode, @FromDate, @ProfitCenterID, @SBU, @ToDate, @TypeID
SP_GetRecommendationForGlobalMap	@BU, @CompanyCode, @FromDate, @ProfitCenterID, @SBU, @ToDate, @TypeID
SP_GetRecommendationsCard	@BU, @CompanyCode, @FromDate, @ProfitCenterID, @SBU, @ToDate, @TypeID
SP_GetRecommendationsStatistics	NULL
SP_GetRegion	NULL
SP_GetRevenueRecommendations	@RecommendationID
SP_GetRevenueTrend	@BU, @CompanyCode, @FromDate, @ProfitCenterID, @SBU, @ToDate, @TypeID
SP_GetRole	NULL
SP_GetSalesVolumeTrend	@BU, @CompanyCode, @FromDate, @ProfitCenterID, @SBU, @ToDate, @TypeID
SP_GetSessionDetails	@SessionID
SP_GetUserMenus	@RoleID, @UserID
SP_GetUsers	NULL
SP_GetVariableCostRecommendations	@RecommendationID
SP_GetViewDataForRecommendations_tobeDelete	@RecommendationID, @TypeID
sp_GetWorkflowDelegationList	@CompanyCode, @FromDate, @ProfitCenter, @ToDate
SP_GetWorkFlowRecommendationDetails	@BU, @CompanyCode, @FromDate, @ProfitCenterID, @SBU, @ToDate
sp_GetWorkflowRedirects	@RecommendationRequestID
SP_GetWorkListActionHistoryDetails	@RequestNumber
SP_GetWorkListChangeSellingVolumeDetails	@RequestNumber
SP_GetWorkListRegionDetails	@RequestNumber
SP_GetWorkListRequestActions	@RequestNumber
SP_GetWorkSummaryCounts	@BU, @CompanyCode, @FromDate, @ProfitCenterID, @SBU, @ToDate
SP_GetXMLValueForLog	@ID, @IdentityColumn, @Tablename, @XMLValue
sp_helpdiagramdefinition	@diagramname, @owner_id
sp_helpdiagrams	@diagramname, @owner_id
SP_Insert_SF_CM_From_SourceView	NULL
SP_Insert_SF_Historic_Cogs_CM_From_SourceView	NULL
SP_Insert_SF_Historic_SalesRevenue_From_SourceView	NULL
SP_Insert_Update_ActivityTracker	@ActivityTrackerID, @CreatedBy, @FunctionID, @ScreenID, @UserActionID
SP_Insert_Update_APIRequestLog	@ApiEndPoint, @AppModuleMappingID, @CreatedBy, @Duration, @HttpMethod, @LayerID, @SessionID, @StatusCode, @UserID, @RequestBody, @RequestLogID, @RequestTimeStamp, @ResponseBody, @ResponseTimeStamp, @RoleID
SP_Insert_Update_AssignedUser	@AffiliateID, @CreatedBy, @Email, @EmployeeID, @FirstName, @IsInsert, @LastName, @StatusID, @UserID, @UserName, @UserRoleIDs
SP_Insert_Update_ErrorLogging	@APIID, @ApplicationID, @CreatedBy, @Environment, @ErrorLogID, @ErrorMessage, @SessionID, @StackTrace, @Status, @StoredProcedureID, @UpdatedBy, @UserID, @LayerID, @ModuleID, @RequestBody, @ResponseBody, @RoleID, @ScreenID, @ErrorNumber, @ErrorSeverity, @ErrorState, @FunctionID, @HostName, @IpAddress
SP_Insert_Update_LoginActivity	@Browser, @BrowserName, @BrowserVersion, @IpAddress, @IsOnline, @LoginID, @UserID, @LoginTime, @LogoutTime, @RoleID, @SessionID, @SessionStartTimeStamp, @UserAgent
SP_Insert_Update_PerformanceLog	@ActionName, @ComponentName, @CreatedBy, @CreatedOn, @Duration, @EndTime, @PerformanceLogID, @RoleID, @SessionID, @StartTime, @UserID
SP_Insert_Update_UserLoginSession	@IsActive, @SessionID, @UserID, @UserLoginSessionID
SP_Insert_Update_UserRoleMapping	@CreatedBy, @DomainUserID, @IsActive, @IsSelectedRole, @RoleIDs, @UserRoleMappingID
SP_Insert_Update_UserToken	@ID, @IsActive, @SessionID, @Token, @UserID
SP_InsertActualsDataFromMasterViews	NULL
SP_InsertDSOutput	NULL
SP_IsInternal_AuthenticatedUser	@Username
SP_LogoutAndEndSessionByUserId	@UserID
sp_renamediagram	@diagramname, @new_diagramname, @owner_id
SP_Update_ErrorLogging_AssigneeWith_Status	@AssigneeUserID, @ErrorLogID, @ErrorStatusID, @UpdatedBy
SP_Update_RecommendationStatus	@ActionTaken, @ActionTakenBy, @Comments, @RecommendationID, @WorkFlowStageName
SP_Update_User_IsActivated	@IsActivated, @UpdatedBy, @UserID
sp_upgraddiagrams	NULL
usp_AddandUpdateUserAndRoleMapping	@Email, @EmployeeId, @FirstName, @LastName, @RoleID, @Username


  public class AccountRepository : IAccountRepository
  {
      private readonly SFDbContext _dbContext;
      private readonly CommonDbContext _commonDbContext;

      public AccountRepository(SFDbContext dbContext, CommonDbContext commonDbContext)
      {
          _dbContext = dbContext;
          _commonDbContext = commonDbContext;
      }

      public async Task<List<UserAuth>> GetUserbyLoginIdAsync(string userName)
      {
          return await _dbContext.UserAuth.FromSqlRaw("EXEC [dbo].[SP_IsInternal_AuthenticatedUser] {0}", userName).ToListAsync();
      }

      public async Task<List<UserDetails>> GetAuthenticatedUserDetails(string userName)
      {
          return await _dbContext.UserDetails.FromSqlRaw("EXEC [dbo].[SP_GetAuthenticatedUserDetails] {0}", userName).ToListAsync();
      }

      /// <summary>
      /// To logout and end sessions of a user
      /// </summary>
      /// <param name="userId"></param>
      /// <returns></returns>
      public async Task LogoutAndEndSessionByUserIdAsync(int userId)
      {
           await _dbContext.Database.ExecuteSqlRawAsync("EXEC [dbo].[SP_LogoutAndEndSessionByUserId] {0}", userId);
      }

      /// <summary>
      /// To fetch valid claims
      /// </summary>
      /// <returns></returns>
      public async Task<GetDataForAuthenticationByUserId> GetDataForAuthenticationByUserIdAsync(int userID)
      {
          var res =  await _dbContext.GetDataForAuthenticationByUserId.FromSqlRaw("EXEC [dbo].[SP_GetDataForAuthenticationByUserId] {0}", userID).ToListAsync();
          return res.FirstOrDefault();
      }

      public async Task<MST_UserDetails_Infopoint?> GetUserFromCommonDb(string userName)
      {
          return await _commonDbContext.MST_UserDetails_Infopoint.Where(x => x.DomainLoginID == userName).FirstOrDefaultAsync();
      }

      public async Task<UserDetails?> GetUserDetails(string userName)
      {
          var response = await _dbContext.UserDetails.FromSqlRaw("EXEC [dbo].[SP_GetUserDetails] {0}", userName).ToListAsync();
          return response?.FirstOrDefault();
      }

      public async Task<UserMenuAccessModel> IsAuthorizedRoleApi(int roleId, string url)
      {
          var res = await _dbContext.UserMenuAccessModel
              .FromSqlRaw(
                  @"EXEC [dbo].[SP_CheckRolePageAccess]
                          @RoleID = @RoleID,
                          @PageUrl = @PageUrl",
                  new SqlParameter("@RoleID", roleId),
                  new SqlParameter("@PageUrl", url)
              )
              .AsNoTracking()
              .ToListAsync();

          return res.FirstOrDefault()!;
      }

  }
