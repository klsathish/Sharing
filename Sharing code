[Fact]
public async Task InvokeAsync_WithValidSession_Should_Insert_Log()
{
    // ---------- ARRANGE ----------
    var logServiceMock = new Mock<IAPIRequestLogService>();

    logServiceMock
        .Setup(x => x.InsertAPIRequestLogsAndPerformanceLog(
            It.IsAny<ApiRequestAndPerformanceLogRequest>(),
            It.IsAny<ApiRequestAndPerformanceLogModels>()))
        .ReturnsAsync(new CommonRes { StatusCode = StatusCodes.Status200OK });

    var context = new DefaultHttpContext();
    context.Request.Path = "/api/test";
    context.Request.Method = "GET";

    // ðŸ”´ VERY IMPORTANT
    context.Response.StatusCode = StatusCodes.Status200OK;

    RequestDelegate next = ctx =>
    {
        ctx.Response.StatusCode = StatusCodes.Status200OK;
        return Task.CompletedTask;
    };

    var middleware = new ApiRequestLoggingMiddleware(
        next,
        logServiceMock.Object);

    // ---------- ACT ----------
    await middleware.InvokeAsync(context);

    // ---------- ASSERT ----------
    logServiceMock.Verify(x =>
        x.InsertAPIRequestLogsAndPerformanceLog(
            It.IsAny<ApiRequestAndPerformanceLogRequest>(),
            It.Is<ApiRequestAndPerformanceLogModels>(m =>
                m.UserID == 1 &&
                m.RoleID == 2 &&
                m.EmployeeName == "John")),
        Times.Once);
}


using Xunit;
using Moq;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.DependencyInjection;
using System.IO;
using System.Text;
using System.Threading.Tasks;
using WCI_APIs.Middlewares;
using WCICore.Contract;
using WCICore.Model;

public class ApiLoggingMiddlewareTests
{
    private DefaultHttpContext CreateContext(string session)
    {
        var context = new DefaultHttpContext();

        context.Request.Body = new MemoryStream(
            Encoding.UTF8.GetBytes("{\"name\":\"test\"}")
        );

        context.Response.Body = new MemoryStream();
        context.Request.Method = "POST";
        context.Request.Scheme = "https";
        context.Request.Host = new HostString("localhost");
        context.Request.Path = "/api/orders/create";
        context.Request.RouteValues["action"] = "create";

        context.Items["Session"] = session; // used by CommonUtils

        return context;
    }

    private ApiLoggingMiddleware CreateMiddleware(
        IAPIRequestLogService logService,
        out bool nextCalled)
    {
        nextCalled = false;

        RequestDelegate next = ctx =>
        {
            nextCalled = true;
            ctx.Response.StatusCode = StatusCodes.Status200OK;
            return ctx.Response.WriteAsync("OK");
        };

        var serviceProvider = new Mock<IServiceProvider>();
        serviceProvider
            .Setup(s => s.GetService(typeof(IAPIRequestLogService)))
            .Returns(logService);

        var scope = new Mock<IServiceScope>();
        scope.Setup(s => s.ServiceProvider)
             .Returns(serviceProvider.Object);

        var scopeFactory = new Mock<IServiceScopeFactory>();
        scopeFactory.Setup(s => s.CreateScope())
                    .Returns(scope.Object);

        return new ApiLoggingMiddleware(next, scopeFactory.Object);
    }

    [Fact]
    public async Task InvokeAsync_WithValidSession_Should_Insert_Log()
    {
        // Arrange
        var context = CreateContext("1:session123:2:John");

        var logServiceMock = new Mock<IAPIRequestLogService>();
        logServiceMock
            .Setup(x => x.InsertAPIRequestLogsAndPerformanceLogs(
                It.IsAny<ApiRequestAndPerformanceLogRequest>(),
                It.IsAny<ApiRequestAndPerformanceLogModel>()))
            .Returns(Task.CompletedTask);

        var middleware = CreateMiddleware(logServiceMock.Object, out bool nextCalled);

        // Act
        await middleware.InvokeAsync(context);

        // Assert
        Assert.True(nextCalled);

        logServiceMock.Verify(
            x => x.InsertAPIRequestLogsAndPerformanceLogs(
                It.IsAny<ApiRequestAndPerformanceLogRequest>(),
                It.Is<ApiRequestAndPerformanceLogModel>(m =>
                    m.UserID == 1 &&
                    m.RoleID == 2 &&
                    m.EmployeeName == "John")),
            Times.Once);
    }

    [Fact]
    public async Task InvokeAsync_WithInvalidSession_Should_Not_Insert_Log()
    {
        // Arrange
        var context = CreateContext(""); // no session

        var logServiceMock = new Mock<IAPIRequestLogService>();

        var middleware = CreateMiddleware(logServiceMock.Object, out bool nextCalled);

        // Act
        await middleware.InvokeAsync(context);

        // Assert
        Assert.True(nextCalled);

        logServiceMock.Verify(
            x => x.InsertAPIRequestLogsAndPerformanceLogs(
                It.IsAny<ApiRequestAndPerformanceLogRequest>(),
                It.IsAny<ApiRequestAndPerformanceLogModel>()),
            Times.Never);
    }

    [Fact]
    public async Task InvokeAsync_WithUserIdZero_Should_Not_Insert_Log()
    {
        // Arrange
        var context = CreateContext("abc:session:xyz:name");

        var logServiceMock = new Mock<IAPIRequestLogService>();

        var middleware = CreateMiddleware(logServiceMock.Object, out bool nextCalled);

        // Act
        await middleware.InvokeAsync(context);

        // Assert
        Assert.True(nextCalled);

        logServiceMock.Verify(
            x => x.InsertAPIRequestLogsAndPerformanceLogs(
                It.IsAny<ApiRequestAndPerformanceLogRequest>(),
                It.IsAny<ApiRequestAndPerformanceLogModel>()),
            Times.Never);
    }
}
