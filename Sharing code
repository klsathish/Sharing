INSERT INTO API_Master
(
    APIName,
    APIEndPointURL,
    IsActive,
    CreatedBy,
    CreatedOn,
    UpdatedBy,
    UpdatedOn,
    FunctionalityID
)
VALUES
-- Account
('Get User Details', '/api/Account/GetUserDetails', 1, 'system', GETDATE(), NULL, NULL, 0),
('Logout', '/api/Account/logout', 1, 'system', GETDATE(), NULL, NULL, 0),

-- Activity Monitoring
('Get Login User Activity', '/api/ActivityMonitoring/getLoginUserActivity', 1, 'system', GETDATE(), NULL, NULL, 0),
('Get Login Activity', '/api/ActivityMonitoring/getLoginActivity', 1, 'system', GETDATE(), NULL, NULL, 0),
('Insert User Activity', '/api/ActivityMonitoring/InsertUserActivity', 1, 'system', GETDATE(), NULL, NULL, 0),

-- API Request Log
('Get API Request Log', '/api/APIRequestLog/getAPIRequestLog', 1, 'system', GETDATE(), NULL, NULL, 0),
('Insert API Request & Performance Logs', '/api/APIRequestLog/insertAPIRequestLogsAndPerformanceLogs', 1, 'system', GETDATE(), NULL, NULL, 0),

-- Authentication
('Login', '/api/Authentication/login', 1, 'system', GETDATE(), NULL, NULL, 0),
('Refresh Token', '/api/Authentication/refreshToken', 1, 'system', GETDATE(), NULL, NULL, 0),

-- Dashboard
('Get Base Filter List', '/api/dashboard/getBaseFilterList', 1, 'system', GETDATE(), NULL, NULL, 0),
('Get More Filters SBU & BU List', '/api/dashboard/getMoreFiltersSBUandBUList', 1, 'system', GETDATE(), NULL, NULL, 0),
('Get More Filters Profit Center List', '/api/dashboard/getMoreFiltersProfitCenterList', 1, 'system', GETDATE(), NULL, NULL, 0),
('Get More Filters Plant List', '/api/dashboard/getMoreFiltersPlantList', 1, 'system', GETDATE(), NULL, NULL, 0),
('Get Inventory Difference Value', '/api/dashboard/getInventoryDifferenceValue', 1, 'system', GETDATE(), NULL, NULL, 0),
('Get Inventory Difference Volume', '/api/dashboard/getInventoryDifferenceVolume', 1, 'system', GETDATE(), NULL, NULL, 0),
('Get Inventory AI Forecast Value', '/api/dashboard/getInventoryAIForecastValue', 1, 'system', GETDATE(), NULL, NULL, 0),
('Get Finished Goods Demand Comparison Value', '/api/dashboard/getFinishedGoodsDemandComparisonValue', 1, 'system', GETDATE(), NULL, NULL, 0),
('Get Finished Goods Production Comparison Value', '/api/dashboard/getFinishedGoodsProductionComparisonValue', 1, 'system', GETDATE(), NULL, NULL, 0),
('Get Finished Goods Demand Chart Data', '/api/dashboard/getFinishedGoodsDemandChartData', 1, 'system', GETDATE(), NULL, NULL, 0),
('Get Finished Goods Production Chart Data', '/api/dashboard/getFinishedGoodsProductionChartData', 1, 'system', GETDATE(), NULL, NULL, 0),
('Get Finished Goods Purchase Chart Data', '/api/dashboard/getFinishedGoodsPurchaseChartData', 1, 'system', GETDATE(), NULL, NULL, 0),
('Get Finished Goods Purchase Comparison Value', '/api/dashboard/getFinishedGoodsPurchaseComparisonValue', 1, 'system', GETDATE(), NULL, NULL, 0),
('Get Inter Company Transfer Comparison Value', '/api/dashboard/getInterCompanyTransferComparisonValue', 1, 'system', GETDATE(), NULL, NULL, 0),
('Get FG InterCompany Transfer STO Chart', '/api/dashboard/getFinishedGoodsInterCompanyTransferChartDataForSTO', 1, 'system', GETDATE(), NULL, NULL, 0),
('Get Total Inventory Value Difference', '/api/dashboard/getTotalInventoryValueDifference', 1, 'system', GETDATE(), NULL, NULL, 0),
('Get Total Inventory Volume Difference', '/api/dashboard/getTotalInventoryVolumeDifference', 1, 'system', GETDATE(), NULL, NULL, 0),
('Get Inventory DIO', '/api/dashboard/getInventoryDIO', 1, 'system', GETDATE(), NULL, NULL, 0),
('Get Inventory Insights Grid Data', '/api/dashboard/getInventoryInsightsGridData', 1, 'system', GETDATE(), NULL, NULL, 0),
('Get FG InterCompany Transfer AIFC GIT Chart', '/api/dashboard/getFGInterCompanyTransferAIFCChartDataForGIT', 1, 'system', GETDATE(), NULL, NULL, 0),
('Get FG InterCompany Transfer AIFC WIP Chart', '/api/dashboard/getFGInterCompanyTransferAIFCChartDataForWIP', 1, 'system', GETDATE(), NULL, NULL, 0),
('Get FG InterCompany Transfer Comparison GIT Chart', '/api/dashboard/getFGInterCompanyTransferComparisonChartDataForGIT', 1, 'system', GETDATE(), NULL, NULL, 0),
('Get Inventory Map Details', '/api/dashboard/getInventoryMapDetails', 1, 'system', GETDATE(), NULL, NULL, 0),
('Get Closing Inventory Balance Chart', '/api/dashboard/getClosingInventoryBalanceChart', 1, 'system', GETDATE(), NULL, NULL, 0),
('Get Closing Inventory Balance Detail Chart', '/api/dashboard/getClosingInventoryBalanceDetailChart', 1, 'system', GETDATE(), NULL, NULL, 0),
('Get Unit Of Measure', '/api/dashboard/getUnitOfMeasure', 1, 'system', GETDATE(), NULL, NULL, 0),

-- Exception Handler
('Log Exception', '/api/exceptionHandler/LogException', 1, 'system', GETDATE(), NULL, NULL, 0),
('Get Error Logs', '/api/exceptionHandler/getErrorLogs', 1, 'system', GETDATE(), NULL, NULL, 0),
('Get All Error Logs', '/api/exceptionHandler/getAllErrorLogs', 1, 'system', GETDATE(), NULL, NULL, 0),
('Get Exception User Activity By Session', '/api/exceptionHandler/getExceptionUserActivityDetailsBySessionID', 1, 'system', GETDATE(), NULL, NULL, 0),
('Update Error Logging Assignee', '/api/exceptionHandler/updateErrorLoggingAssigneeWithStatus', 1, 'system', GETDATE(), NULL, NULL, 0),
('Get Error Log Assign Details', '/api/exceptionHandler/getErrorLogAssignDetailsAsync', 1, 'system', GETDATE(), NULL, NULL, 0),

-- Performance
('Get API Performance Logs', '/api/APIPerformance/getPerformanceLogs', 1, 'system', GETDATE(), NULL, NULL, 0),

-- Raw Materials
('Get RM Goods Receipt Chart', '/api/APIRawMaterials/getRawMaterialsGoodsReceiptChartData', 1, 'system', GETDATE(), NULL, NULL, 0),
('Get RM Consumed Production Chart', '/api/APIRawMaterials/getRawMaterialsConsumedProductionChartData', 1, 'system', GETDATE(), NULL, NULL, 0),
('Get RM Consumed Comparison Value', '/api/APIRawMaterials/getRawMaterialsConsumedComparisonValue', 1, 'system', GETDATE(), NULL, NULL, 0),
('Get RM Goods Receipt Comparison Value', '/api/APIRawMaterials/getRawMaterialsGoodsReceiptComparisonValue', 1, 'system', GETDATE(), NULL, NULL, 0),
('Get RM InterCompany Transfer Chart', '/api/APIRawMaterials/getRMInterCompanyTransferChartData', 1, 'system', GETDATE(), NULL, NULL, 0),
('Get RM InterCompany Transfer Comparison Value', '/api/APIRawMaterials/getRMInterCompanyTransferComparisonValue', 1, 'system', GETDATE(), NULL, NULL, 0),
('Get RM Consumption Trend Chart', '/api/APIRawMaterials/getRMConsumptionTrendChartData', 1, 'system', GETDATE(), NULL, NULL, 0),
('Get RM Consumption Trend Comparison Data', '/api/APIRawMaterials/getRMConsumptionTrendComparisonData', 1, 'system', GETDATE(), NULL, NULL, 0),

-- User Management
('Get User List', '/api/userManagement/getUserList', 1, 'system', GETDATE(), NULL, NULL, 0),
('Get User Menu List', '/api/userManagement/getUserMenuList', 1, 'system', GETDATE(), NULL, NULL, 0),
('Insert/Update User Details', '/api/userManagement/insertupdateUserDetails', 1, 'system', GETDATE(), NULL, NULL, 0),
('Deactivate User', '/api/userManagement/deactivateUser', 1, 'system', GETDATE(), NULL, NULL, 0),
('Search User From AD', '/api/userManagement/getSearchUserListFromAD/{searchText}', 1, 'system', GETDATE(), NULL, NULL, 0),
('Get Role List', '/api/userManagement/getRoleList', 1, 'system', GETDATE(), NULL, NULL, 0),
('Get Affiliate List', '/api/userManagement/getAffiliateList', 1, 'system', GETDATE(), NULL, NULL, 0),
('Is Authorized User Menu', '/api/userManagement/isAuthorizedUserMenu', 1, 'system', GETDATE(), NULL, NULL, 0);





Table 
APIID	APIName	APIEndPointURL	IsActive	CreatedBy	CreatedOn	UpdatedBy	UpdatedOn	FunctionalityID
1	Get User Details	/api/Account/GetUserDetails	1	sabiccorp\30790093	2025-03-19 16:09:10.703	NULL	NULL	4
2	Get Login UserActivity	/api/ActivityMonitoring/getLoginUserActivity	1	sabiccorp\30790093	2025-04-09 15:01:49.623	NULL	NULL	6

-------------

Account


GET
/api/Account/GetUserDetails



GET
/api/Account/logout


ActivityMonitoring


POST
/api/ActivityMonitoring/getLoginUserActivity



POST
/api/ActivityMonitoring/getLoginActivity



POST
/api/ActivityMonitoring/InsertUserActivity


APIRequestLog


POST
/api/APIRequestLog/getAPIRequestLog



POST
/api/APIRequestLog/insertAPIRequestLogsAndPerformanceLogs


Authentication


GET
/api/Authentication/login



POST
/api/Authentication/refreshToken


Dashboard


POST
/api/dashboard/getBaseFilterList



POST
/api/dashboard/getMoreFiltersSBUandBUList



POST
/api/dashboard/getMoreFiltersProfitCenterList



POST
/api/dashboard/getMoreFiltersPlantList



POST
/api/dashboard/getInventoryDifferenceValue



POST
/api/dashboard/getInventoryDifferenceVolume



POST
/api/dashboard/getInventoryAIForecastValue



POST
/api/dashboard/getFinishedGoodsDemandComparisonValue



POST
/api/dashboard/getFinishedGoodsProductionComparisonValue



POST
/api/dashboard/getFinishedGoodsDemandChartData



POST
/api/dashboard/getFinishedGoodsProductionChartData



POST
/api/dashboard/getFinishedGoodsPurchaseChartData



POST
/api/dashboard/getFinishedGoodsPurchaseComparisonValue



POST
/api/dashboard/getInterCompanyTransferComparisonValue



POST
/api/dashboard/getFinishedGoodsInterCompanyTransferChartDataForSTO



POST
/api/dashboard/getTotalInventoryValueDifference



POST
/api/dashboard/getTotalInventoryVolumeDifference



POST
/api/dashboard/getInventoryDIO



POST
/api/dashboard/getInventoryInsightsGridData



POST
/api/dashboard/getFGInterCompanyTransferAIFCChartDataForGIT



POST
/api/dashboard/getFGInterCompanyTransferAIFCChartDataForWIP



POST
/api/dashboard/getFGInterCompanyTransferComparisonChartDataForGIT



POST
/api/dashboard/getInventoryMapDetails



POST
/api/dashboard/getClosingInventoryBalanceChart



POST
/api/dashboard/getClosingInventoryBalanceDetailChart



POST
/api/dashboard/getUnitOfMeasure


ExceptionHandler


POST
/api/exceptionHandler/LogException



POST
/api/exceptionHandler/getErrorLogs



POST
/api/exceptionHandler/getAllErrorLogs



GET
/api/exceptionHandler/getExceptionUserActivityDetailsBySessionID



POST
/api/exceptionHandler/updateErrorLoggingAssigneeWithStatus



GET
/api/exceptionHandler/getErrorLogAssignDetailsAsync


Performance


POST
/api/APIPerformance/getPerformanceLogs


RawMaterials


POST
/api/APIRawMaterials/getRawMaterialsGoodsReceiptChartData



POST
/api/APIRawMaterials/getRawMaterialsConsumedProductionChartData



POST
/api/APIRawMaterials/getRawMaterialsConsumedComparisonValue



POST
/api/APIRawMaterials/getRawMaterialsGoodsReceiptComparisonValue



POST
/api/APIRawMaterials/getRMInterCompanyTransferChartData



POST
/api/APIRawMaterials/getRMInterCompanyTransferComparisonValue



POST
/api/APIRawMaterials/getRMConsumptionTrendChartData



POST
/api/APIRawMaterials/getRMConsumptionTrendComparisonData


UserManagement


GET
/api/userManagement/getUserList



GET
/api/userManagement/getUserMenuList



POST
/api/userManagement/insertupdateUserDetails



POST
/api/userManagement/deactivateUser



GET
/api/userManagement/getSearchUserListFromAD/{searchText}



GET
/api/userManagement/getRoleList



GET
/api/userManagement/getAffiliateList



POST
/api/userManagement/isAuthorizedUserMenu


const resolveEnv = (value, fallback) => {

  if (!value) return fallback;

  // remove spaces
  value = value.trim();

  // if looks like #VAR#
  if (/^#.+#$/.test(value)) return fallback;

  return value;
};

Great üëç ‚Äî let‚Äôs do it the clean way using IMemoryCache in .NET.
You want:
‚úî Load all page URLs from DB
‚úî Store them in memory cache
‚úî Reuse them in middleware
‚úî Refresh only when needed
‚úÖ Step-by-Step Implementation
1Ô∏è‚É£ Register MemoryCache
In Program.cs
Copy code
Csharp
builder.Services.AddMemoryCache();
2Ô∏è‚É£ Create a Service to Load & Cache Page URLs
This keeps middleware clean üëç
Copy code
Csharp
public interface IPageService
{
    Task<List<string>> GetPageUrlsAsync();
}
Implementation
Copy code
Csharp
public class PageService : IPageService
{
    private readonly IMemoryCache _cache;
    private readonly MyDbContext _db;
    private const string CacheKey = "PAGE_URL_LIST";

    public PageService(IMemoryCache cache, MyDbContext db)
    {
        _cache = cache;
        _db = db;
    }

    public async Task<List<string>> GetPageUrlsAsync()
    {
        if (!_cache.TryGetValue(CacheKey, out List<string> urls))
        {
            urls = await _db.Pages
                .Select(x => x.ApiUrl)
                .ToListAsync();

            var cacheOptions = new MemoryCacheEntryOptions()
                .SetSlidingExpiration(TimeSpan.FromMinutes(30))   // reset if accessed
                .SetAbsoluteExpiration(TimeSpan.FromHours(4));     // refresh max time

            _cache.Set(CacheKey, urls, cacheOptions);
        }

        return urls;
    }
}
3Ô∏è‚É£ Register the Service
Copy code
Csharp
builder.Services.AddScoped<IPageService, PageService>();
4Ô∏è‚É£ Use It in Your Middleware
Copy code
Csharp
public class RoleAuthorizationMiddleware
{
    private readonly RequestDelegate _next;
    private readonly IPageService _pageService;

    public RoleAuthorizationMiddleware(RequestDelegate next, IPageService pageService)
    {
        _next = next;
        _pageService = pageService;
    }

    public async Task InvokeAsync(HttpContext context)
    {
        var path = context.Request.Path.Value!.ToLower().TrimEnd('/');

        var pageUrls = await _pageService.GetPageUrlsAsync();

        bool isPageApi = pageUrls.Any(url =>
            path.StartsWith(url.ToLower(), StringComparison.OrdinalIgnoreCase));

        if (isPageApi)
        {
            var roleId = context.User.FindFirst("roleid")?.Value;

            bool hasAccess = await CheckRoleAccess(roleId, path);

            if (!hasAccess)
            {
                context.Response.StatusCode = 403;
                await context.Response.WriteAsync("Access denied.");
                return;
            }
        }

        await _next(context);
    }
}
üí® Performance Result
‚úî DB hit only once
‚úî Reused for 30 mins (or until restart)
‚úî Blazing fast middleware
‚úî You control cache policy
üîÅ Optional: Force Refresh Cache When Menu Updates
Add:
Copy code
Csharp
_cache.Remove("PAGE_URL_LIST");
After admin updates menu
(Example: inside save/update method)
üõ° Bonus Hardening
Normalize URLs before match:
Copy code
Csharp
path = path.Split('?')[0];
üéØ Summary
Feature
Status
Page APIs
üîê Role Checked
Chart/Grid APIs
üü¢ Auto Allowed
DB Load
‚ö° Cached
Code
Clean & maintainable
If you want, I can also help you:
‚úÖ add reload signal
‚úÖ add logging
‚úÖ unit test
‚úÖ Redis cache (for multi-server)
Just tell me üëç
[HttpPost("insertAPIRequestLogsAndPerformanceLogs")]
 public async Task<IActionResult> InsertAPIRequestLogsAndPerformanceLogs([FromBody] ApiRequestAndPerformanceLogRequest apiRequestAndPerformanceLogRequest)
 {
     ApiRequestAndPerformanceLogModel apiRequestAndPerformanceLogModel = new ApiRequestAndPerformanceLogModel();
     var loginSession = CommonUtils.GetCurrentSession(HttpContext);
     if (!string.IsNullOrEmpty(loginSession) && loginSession.Contains(":"))
     {
         var inpSes = loginSession.Split(':');
         apiRequestAndPerformanceLogModel.UserID = !string.IsNullOrEmpty(inpSes[0]) ? Int32.Parse(inpSes[0]) : 0;
         apiRequestAndPerformanceLogModel.SessionID = inpSes[1];
         apiRequestAndPerformanceLogModel.RoleID = !string.IsNullOrEmpty(inpSes[2]) ? Int32.Parse(inpSes[2]) : 0;
         apiRequestAndPerformanceLogModel.EmployeeName = inpSes[3];
         apiRequestAndPerformanceLogModel.CreatedBy = inpSes[3];
     }
     apiRequestAndPerformanceLogModel.CreatedOn = DateTime.Now;
     TimeSpan elapsedTime = apiRequestAndPerformanceLogRequest.ResponseTimeStamp - apiRequestAndPerformanceLogRequest.RequestTimeStamp;
     apiRequestAndPerformanceLogModel.Duration = $"{elapsedTime.TotalMilliseconds} ms";
     var response = await _iAPIRequestLogService.InsertAPIRequestLogsAndPerformanceLogs(apiRequestAndPerformanceLogRequest, apiRequestAndPerformanceLogModel);
     return StatusCode(response.StatusCode, response);
 }


[ExcludeFromCodeCoverage]
public class ApiRequestAndPerformanceLogRequest
{
    public int AppModuleMappingID { get; set; }
    public string? ApiEndPoint { get; set; }
    public string? RequestBody { get; set; }
    public string? HttpMethod { get; set; }
    public int? StatusCode { get; set; }
    public DateTime RequestTimeStamp { get; set; }
    public string? ResponseBody { get; set; }
    public DateTime ResponseTimeStamp { get; set; }
    public int? LayerID { get; set; }
    public string? ComponentName { get; set; }
    public string? ActionName { get; set; }
}
[ExcludeFromCodeCoverage]
public class ApiRequestAndPerformanceLogModel
{
    public int UserID { get; set; }
    public int RoleID { get; set; }
    public string? EmployeeName { get; set; }
    public string? RoleName { get; set; }
    public string? SessionID { get; set; }
    public string? Duration { get; set; }
    public string? CreatedBy { get; set; }
    public DateTime CreatedOn { get; set; }
}



        public async Task<string> InsertAPIRequestLogsAndPerformanceLogs(ApiRequestAndPerformanceLogRequest apiRequestAndPerformanceLogRequest, ApiRequestAndPerformanceLogModel apiRequestAndPerformanceLogModel)
        {
            var apiRequestLog = await _dbContext.Database.ExecuteSqlRawAsync("EXEC [dbo].[SP_Insert_Update_APIRequestLog] {0},{1},{2},{3},{4},{5},{6},{7},{8},{9},{10},{11},{12},{13},{14}"
                   , 0
                   , apiRequestAndPerformanceLogModel.UserID
                   , apiRequestAndPerformanceLogModel.RoleID
                   , apiRequestAndPerformanceLogModel.SessionID
                   , apiRequestAndPerformanceLogRequest.AppModuleMappingID
                   , apiRequestAndPerformanceLogRequest.ApiEndPoint
                   , apiRequestAndPerformanceLogRequest.HttpMethod
                   , apiRequestAndPerformanceLogRequest.StatusCode
                   , apiRequestAndPerformanceLogRequest.RequestBody
                   , apiRequestAndPerformanceLogRequest.RequestTimeStamp
                   , apiRequestAndPerformanceLogRequest.ResponseBody
                   , apiRequestAndPerformanceLogRequest.RequestTimeStamp
                   , apiRequestAndPerformanceLogModel.Duration
                   , apiRequestAndPerformanceLogModel.CreatedBy
                   , apiRequestAndPerformanceLogRequest.LayerID
                   );
            if (apiRequestLog == 0)
            {
                return SabicConstants.BadRequestMessage;
            }
            var performanceLog = await _dbContext.Database.ExecuteSqlRawAsync("EXEC [dbo].[SP_Insert_Update_PerformanceLog] {0},{1},{2},{3},{4},{5},{6},{7},{8},{9},{10}"
                   , 0
                   , apiRequestAndPerformanceLogModel.UserID
                   , apiRequestAndPerformanceLogModel.RoleID
                   , apiRequestAndPerformanceLogModel.SessionID
                   , apiRequestAndPerformanceLogRequest.ComponentName
                   , apiRequestAndPerformanceLogRequest.ActionName
                   , apiRequestAndPerformanceLogRequest.RequestTimeStamp
                   , apiRequestAndPerformanceLogRequest.ResponseTimeStamp
                   , apiRequestAndPerformanceLogModel.Duration
                   , apiRequestAndPerformanceLogModel.CreatedBy
                   , apiRequestAndPerformanceLogModel.CreatedOn
                   );
            if (performanceLog == 0)
            {
                return SabicConstants.BadRequestMessage;
            }
            return SabicConstants.SuccessMessage;
        }


need to work 
Performance Log - need to log every API call which are called, need to log from middleware not from react
Restrict the page access using role level routing from middleware  



----------------------


‚úÖ Middleware 1 ‚Äî Performance + API Request Log Middleware

This middleware:

Captures Request Timestamp

Reads body (optional)

Calls next()

Captures Response Timestamp

Reads session details (same as your code)

Calls your service method

You can adjust logs as needed

public class ApiLoggingMiddleware
{
    private readonly RequestDelegate _next;
    private readonly IAPIRequestLogService _logService;

    public ApiLoggingMiddleware(RequestDelegate next,
        IAPIRequestLogService logService)
    {
        _next = next;
        _logService = logService;
    }

    public async Task InvokeAsync(HttpContext context)
    {
        var requestTime = DateTime.Now;

        // READ REQUEST BODY
        context.Request.EnableBuffering();
        string requestBody = "";
        using (var reader = new StreamReader(context.Request.Body, leaveOpen: true))
        {
            requestBody = await reader.ReadToEndAsync();
            context.Request.Body.Position = 0;
        }

        // CALL API
        await _next(context);

        var responseTime = DateTime.Now;

        // READ SESSION (SAME AS YOUR CODE)
        var loginSession = CommonUtils.GetCurrentSession(context);

        var model = new ApiRequestAndPerformanceLogModel();

        if (!string.IsNullOrEmpty(loginSession) && loginSession.Contains(":"))
        {
            var inpSes = loginSession.Split(':');

            model.UserID = int.TryParse(inpSes[0], out var uid) ? uid : 0;
            model.SessionID = inpSes[1];
            model.RoleID = int.TryParse(inpSes[2], out var rid) ? rid : 0;
            model.EmployeeName = inpSes[3];
            model.CreatedBy = inpSes[3];
        }

        model.CreatedOn = DateTime.Now;
        model.Duration = (responseTime - requestTime).TotalMilliseconds + " ms";

        var apiReq = new ApiRequestAndPerformanceLogRequest
        {
            ApiEndPoint = context.Request.Path,
            HttpMethod = context.Request.Method,
            StatusCode = context.Response.StatusCode,
            RequestBody = requestBody,
            RequestTimeStamp = requestTime,
            ResponseTimeStamp = responseTime,
            ResponseBody = null, // If needed capture response
            ComponentName = "API",
            ActionName = context.Request.Path
        };

        await _logService.InsertAPIRequestLogsAndPerformanceLogs(apiReq, model);
    }
}

üöÄ Register Middleware (Program.cs)
app.UseMiddleware<ApiLoggingMiddleware>();


üëâ Put it after authentication but before MapControllers

app.UseAuthentication();
app.UseAuthorization();

app.UseMiddleware<ApiLoggingMiddleware>();

app.MapControllers();

üõë Middleware 2 ‚Äî Role Based Access Restriction
üéØ Requirement

Restrict endpoint based on role

Middleware should read role from session

‚úÖ Example Usage Pattern

You can define allowed role mapping like:

public static class RoleAccessConfig
{
    public static Dictionary<string, List<int>> RoleAccess = new()
    {
        { "/admin", new List<int>{1} }, // Only role 1
        { "/reports", new List<int>{1,2} }
    };
}

üîí Middleware Code
public class RoleAuthorizationMiddleware
{
    private readonly RequestDelegate _next;

    public RoleAuthorizationMiddleware(RequestDelegate next)
    {
        _next = next;
    }

    public async Task InvokeAsync(HttpContext context)
    {
        var path = context.Request.Path.ToString().ToLower();

        // Check if restriction exists
        var restricted = RoleAccessConfig.RoleAccess
            .FirstOrDefault(r => path.StartsWith(r.Key));

        if (!string.IsNullOrEmpty(restricted.Key))
        {
            var loginSession = CommonUtils.GetCurrentSession(context);

            int roleId = 0;

            if (!string.IsNullOrEmpty(loginSession)
                && loginSession.Contains(":"))
            {
                var inpSes = loginSession.Split(':');
                int.TryParse(inpSes[2], out roleId);
            }

            if (!restricted.Value.Contains(roleId))
            {
                context.Response.StatusCode = StatusCodes.Status403Forbidden;
                await context.Response.WriteAsync("Access Denied");
                return;
            }
        }

        await _next(context);
    }
}

üß© Register Role Middleware (Before Logging)
app.UseMiddleware<RoleAuthorizationMiddleware>();
app.UseMiddleware<ApiLoggingMiddleware>();

üéâ Result
====================

public class ApiLoggingMiddleware
{
    private readonly RequestDelegate _next;
    private readonly IAPIRequestLogService _logService;

    public ApiLoggingMiddleware(RequestDelegate next,
        IAPIRequestLogService logService)
    {
        _next = next;
        _logService = logService;
    }

    public async Task InvokeAsync(HttpContext context)
    {
        var requestTime = DateTime.Now;

        // ===== READ REQUEST BODY =====
        context.Request.EnableBuffering();
        string requestBody = "";
        using (var reader = new StreamReader(context.Request.Body, leaveOpen: true))
        {
            requestBody = await reader.ReadToEndAsync();
            context.Request.Body.Position = 0;
        }

        // ===== CAPTURE RESPONSE BODY =====
        var originalBodyStream = context.Response.Body;
        using var responseBodyStream = new MemoryStream();
        context.Response.Body = responseBodyStream;

        // ===== CALL NEXT MIDDLEWARE =====
        await _next(context);

        var responseTime = DateTime.Now;

        // ===== READ RESPONSE BODY =====
        context.Response.Body.Seek(0, SeekOrigin.Begin);
        var responseBody = await new StreamReader(context.Response.Body).ReadToEndAsync();
        context.Response.Body.Seek(0, SeekOrigin.Begin);

        // ===== COPY BACK TO ORIGINAL STREAM =====
        await responseBodyStream.CopyToAsync(originalBodyStream);

        // ===== READ SESSION DATA (SAME AS YOUR CODE) =====
        var loginSession = CommonUtils.GetCurrentSession(context);

        var model = new ApiRequestAndPerformanceLogModel();

        if (!string.IsNullOrEmpty(loginSession) && loginSession.Contains(":"))
        {
            var inpSes = loginSession.Split(':');

            model.UserID = int.TryParse(inpSes[0], out var uid) ? uid : 0;
            model.SessionID = inpSes[1];
            model.RoleID = int.TryParse(inpSes[2], out var rid) ? rid : 0;
            model.EmployeeName = inpSes[3];
            model.CreatedBy = inpSes[3];
        }

        model.CreatedOn = DateTime.Now;
        model.Duration = (responseTime - requestTime).TotalMilliseconds + " ms";

        var apiReq = new ApiRequestAndPerformanceLogRequest
        {
            ApiEndPoint = context.Request.Path,
            HttpMethod = context.Request.Method,
            StatusCode = context.Response.StatusCode,
            RequestBody = requestBody,
            RequestTimeStamp = requestTime,
            ResponseTimeStamp = responseTime,
            ResponseBody = responseBody,
            ComponentName = "API",
            ActionName = context.Request.Path
        };

        await _logService.InsertAPIRequestLogsAndPerformanceLogs(apiReq, model);
    }
}

-----

public class RoleAuthorizationMiddleware
{
    private readonly RequestDelegate _next;
    private readonly YourDbContext _db;

    public RoleAuthorizationMiddleware(RequestDelegate next, YourDbContext db)
    {
        _next = next;
        _db = db;
    }

    public async Task InvokeAsync(HttpContext context)
    {
        var path = context.Request.Path.ToString().ToLower();

        // Skip login / swagger / health check etc.
        if (path.Contains("login") || path.StartsWith("/swagger"))
        {
            await _next(context);
            return;
        }

        // ===== Read Session =====
        var loginSession = CommonUtils.GetCurrentSession(context);

        int roleId = 0;

        if (!string.IsNullOrEmpty(loginSession) && loginSession.Contains(":"))
        {
            var ses = loginSession.Split(':');

            // ses[2] = RoleId
            int.TryParse(ses[2], out roleId);
        }

        // If role not resolved -> not authorized
        if (roleId == 0)
        {
            context.Response.StatusCode = StatusCodes.Status401Unauthorized;
            await context.Response.WriteAsync("Role missing or invalid");
            return;
        }

        // ===== Call Stored Procedure =====
        var result = await _db.MyAccessChecks
            .FromSqlRaw(
                "EXEC SP_Validate_RolePageAccess {0}, {1}",
                roleId,
                path)
            .ToListAsync();

        var isAllowed = result.Any();

        if (!isAllowed)
        {
            context.Response.StatusCode = StatusCodes.Status403Forbidden;
            await context.Response.WriteAsync("Access Denied");
            return;
        }

        await _next(context);
    }
}

