set -e

echo "Switching to source directory"
cd "$(Build.SourcesDirectory)"

echo "Current directory:"
pwd

echo "=== Find test csproj ==="
TEST_CSPROJ=$(find . -name "WCI_APIs_Test.csproj" | head -n 1)

echo "Using test project: $TEST_CSPROJ"

if [ -z "$TEST_CSPROJ" ]; then
  echo "ERROR: Test project not found"
  exit 1
fi

dotnet test "$TEST_CSPROJ" \
  --configuration Release \
  --collect:"XPlat Code Coverage" \
  -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=opencover,cobertura \
  --logger trx \
  --results-directory "$(Build.SourcesDirectory)/TestResults"
