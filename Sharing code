 [HttpPost("insertAPIRequestLogsAndPerformanceLogs")]
 public async Task<IActionResult> InsertAPIRequestLogsAndPerformanceLogs([FromBody] ApiRequestAndPerformanceLogRequest apiRequestAndPerformanceLogRequest)
 {
     ApiRequestAndPerformanceLogModel apiRequestAndPerformanceLogModel = new ApiRequestAndPerformanceLogModel();
     var loginSession = CommonUtils.GetCurrentSession(HttpContext);
     if (!string.IsNullOrEmpty(loginSession) && loginSession.Contains(":"))
     {
         var inpSes = loginSession.Split(':');
         apiRequestAndPerformanceLogModel.UserID = !string.IsNullOrEmpty(inpSes[0]) ? Int32.Parse(inpSes[0]) : 0;
         apiRequestAndPerformanceLogModel.SessionID = inpSes[1];
         apiRequestAndPerformanceLogModel.RoleID = !string.IsNullOrEmpty(inpSes[2]) ? Int32.Parse(inpSes[2]) : 0;
         apiRequestAndPerformanceLogModel.EmployeeName = inpSes[3];
         apiRequestAndPerformanceLogModel.CreatedBy = inpSes[3];
     }
     apiRequestAndPerformanceLogModel.CreatedOn = DateTime.Now;
     TimeSpan elapsedTime = apiRequestAndPerformanceLogRequest.ResponseTimeStamp - apiRequestAndPerformanceLogRequest.RequestTimeStamp;
     apiRequestAndPerformanceLogModel.Duration = $"{elapsedTime.TotalMilliseconds} ms";
     var response = await _iAPIRequestLogService.InsertAPIRequestLogsAndPerformanceLogs(apiRequestAndPerformanceLogRequest, apiRequestAndPerformanceLogModel);
     return StatusCode(response.StatusCode, response);
 }


[ExcludeFromCodeCoverage]
public class ApiRequestAndPerformanceLogRequest
{
    public int AppModuleMappingID { get; set; }
    public string? ApiEndPoint { get; set; }
    public string? RequestBody { get; set; }
    public string? HttpMethod { get; set; }
    public int? StatusCode { get; set; }
    public DateTime RequestTimeStamp { get; set; }
    public string? ResponseBody { get; set; }
    public DateTime ResponseTimeStamp { get; set; }
    public int? LayerID { get; set; }
    public string? ComponentName { get; set; }
    public string? ActionName { get; set; }
}
[ExcludeFromCodeCoverage]
public class ApiRequestAndPerformanceLogModel
{
    public int UserID { get; set; }
    public int RoleID { get; set; }
    public string? EmployeeName { get; set; }
    public string? RoleName { get; set; }
    public string? SessionID { get; set; }
    public string? Duration { get; set; }
    public string? CreatedBy { get; set; }
    public DateTime CreatedOn { get; set; }
}



        public async Task<string> InsertAPIRequestLogsAndPerformanceLogs(ApiRequestAndPerformanceLogRequest apiRequestAndPerformanceLogRequest, ApiRequestAndPerformanceLogModel apiRequestAndPerformanceLogModel)
        {
            var apiRequestLog = await _dbContext.Database.ExecuteSqlRawAsync("EXEC [dbo].[SP_Insert_Update_APIRequestLog] {0},{1},{2},{3},{4},{5},{6},{7},{8},{9},{10},{11},{12},{13},{14}"
                   , 0
                   , apiRequestAndPerformanceLogModel.UserID
                   , apiRequestAndPerformanceLogModel.RoleID
                   , apiRequestAndPerformanceLogModel.SessionID
                   , apiRequestAndPerformanceLogRequest.AppModuleMappingID
                   , apiRequestAndPerformanceLogRequest.ApiEndPoint
                   , apiRequestAndPerformanceLogRequest.HttpMethod
                   , apiRequestAndPerformanceLogRequest.StatusCode
                   , apiRequestAndPerformanceLogRequest.RequestBody
                   , apiRequestAndPerformanceLogRequest.RequestTimeStamp
                   , apiRequestAndPerformanceLogRequest.ResponseBody
                   , apiRequestAndPerformanceLogRequest.RequestTimeStamp
                   , apiRequestAndPerformanceLogModel.Duration
                   , apiRequestAndPerformanceLogModel.CreatedBy
                   , apiRequestAndPerformanceLogRequest.LayerID
                   );
            if (apiRequestLog == 0)
            {
                return SabicConstants.BadRequestMessage;
            }
            var performanceLog = await _dbContext.Database.ExecuteSqlRawAsync("EXEC [dbo].[SP_Insert_Update_PerformanceLog] {0},{1},{2},{3},{4},{5},{6},{7},{8},{9},{10}"
                   , 0
                   , apiRequestAndPerformanceLogModel.UserID
                   , apiRequestAndPerformanceLogModel.RoleID
                   , apiRequestAndPerformanceLogModel.SessionID
                   , apiRequestAndPerformanceLogRequest.ComponentName
                   , apiRequestAndPerformanceLogRequest.ActionName
                   , apiRequestAndPerformanceLogRequest.RequestTimeStamp
                   , apiRequestAndPerformanceLogRequest.ResponseTimeStamp
                   , apiRequestAndPerformanceLogModel.Duration
                   , apiRequestAndPerformanceLogModel.CreatedBy
                   , apiRequestAndPerformanceLogModel.CreatedOn
                   );
            if (performanceLog == 0)
            {
                return SabicConstants.BadRequestMessage;
            }
            return SabicConstants.SuccessMessage;
        }


need to work 
Performance Log - need to log every API call which are called, need to log from middleware not from react
Restrict the page access using role level routing from middleware  



----------------------


âœ… Middleware 1 â€” Performance + API Request Log Middleware

This middleware:

Captures Request Timestamp

Reads body (optional)

Calls next()

Captures Response Timestamp

Reads session details (same as your code)

Calls your service method

You can adjust logs as needed

public class ApiLoggingMiddleware
{
    private readonly RequestDelegate _next;
    private readonly IAPIRequestLogService _logService;

    public ApiLoggingMiddleware(RequestDelegate next,
        IAPIRequestLogService logService)
    {
        _next = next;
        _logService = logService;
    }

    public async Task InvokeAsync(HttpContext context)
    {
        var requestTime = DateTime.Now;

        // READ REQUEST BODY
        context.Request.EnableBuffering();
        string requestBody = "";
        using (var reader = new StreamReader(context.Request.Body, leaveOpen: true))
        {
            requestBody = await reader.ReadToEndAsync();
            context.Request.Body.Position = 0;
        }

        // CALL API
        await _next(context);

        var responseTime = DateTime.Now;

        // READ SESSION (SAME AS YOUR CODE)
        var loginSession = CommonUtils.GetCurrentSession(context);

        var model = new ApiRequestAndPerformanceLogModel();

        if (!string.IsNullOrEmpty(loginSession) && loginSession.Contains(":"))
        {
            var inpSes = loginSession.Split(':');

            model.UserID = int.TryParse(inpSes[0], out var uid) ? uid : 0;
            model.SessionID = inpSes[1];
            model.RoleID = int.TryParse(inpSes[2], out var rid) ? rid : 0;
            model.EmployeeName = inpSes[3];
            model.CreatedBy = inpSes[3];
        }

        model.CreatedOn = DateTime.Now;
        model.Duration = (responseTime - requestTime).TotalMilliseconds + " ms";

        var apiReq = new ApiRequestAndPerformanceLogRequest
        {
            ApiEndPoint = context.Request.Path,
            HttpMethod = context.Request.Method,
            StatusCode = context.Response.StatusCode,
            RequestBody = requestBody,
            RequestTimeStamp = requestTime,
            ResponseTimeStamp = responseTime,
            ResponseBody = null, // If needed capture response
            ComponentName = "API",
            ActionName = context.Request.Path
        };

        await _logService.InsertAPIRequestLogsAndPerformanceLogs(apiReq, model);
    }
}

ðŸš€ Register Middleware (Program.cs)
app.UseMiddleware<ApiLoggingMiddleware>();


ðŸ‘‰ Put it after authentication but before MapControllers

app.UseAuthentication();
app.UseAuthorization();

app.UseMiddleware<ApiLoggingMiddleware>();

app.MapControllers();

ðŸ›‘ Middleware 2 â€” Role Based Access Restriction
ðŸŽ¯ Requirement

Restrict endpoint based on role

Middleware should read role from session

âœ… Example Usage Pattern

You can define allowed role mapping like:

public static class RoleAccessConfig
{
    public static Dictionary<string, List<int>> RoleAccess = new()
    {
        { "/admin", new List<int>{1} }, // Only role 1
        { "/reports", new List<int>{1,2} }
    };
}

ðŸ”’ Middleware Code
public class RoleAuthorizationMiddleware
{
    private readonly RequestDelegate _next;

    public RoleAuthorizationMiddleware(RequestDelegate next)
    {
        _next = next;
    }

    public async Task InvokeAsync(HttpContext context)
    {
        var path = context.Request.Path.ToString().ToLower();

        // Check if restriction exists
        var restricted = RoleAccessConfig.RoleAccess
            .FirstOrDefault(r => path.StartsWith(r.Key));

        if (!string.IsNullOrEmpty(restricted.Key))
        {
            var loginSession = CommonUtils.GetCurrentSession(context);

            int roleId = 0;

            if (!string.IsNullOrEmpty(loginSession)
                && loginSession.Contains(":"))
            {
                var inpSes = loginSession.Split(':');
                int.TryParse(inpSes[2], out roleId);
            }

            if (!restricted.Value.Contains(roleId))
            {
                context.Response.StatusCode = StatusCodes.Status403Forbidden;
                await context.Response.WriteAsync("Access Denied");
                return;
            }
        }

        await _next(context);
    }
}

ðŸ§© Register Role Middleware (Before Logging)
app.UseMiddleware<RoleAuthorizationMiddleware>();
app.UseMiddleware<ApiLoggingMiddleware>();

ðŸŽ‰ Result

