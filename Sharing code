public class UserManagementRepository : IUserManagementRepository
{
    private readonly SFDbContext _dbContext;
    private readonly CommonDbContext _commonDbContext;

    public UserManagementRepository(SFDbContext dbContext, CommonDbContext commonDbContext)
    {
        _dbContext = dbContext;
        _commonDbContext = commonDbContext;
    }

    #region Helpers

    private static object DbString(string? value) =>
        string.IsNullOrWhiteSpace(value) ? DBNull.Value : value;

    private static object DbValue<T>(T? value) where T : struct =>
        value ?? (object)DBNull.Value;

    #endregion

    public async Task<List<UserMenu>> GetUserMenuList(int userId, int roleId)
        => await _dbContext.UserMenu.FromSqlRaw(
            "EXEC dbo.SP_GetUserMenus @UserId, @RoleId",
            new SqlParameter("@UserId", userId),
            new SqlParameter("@RoleId", roleId)
        ).ToListAsync();

    public async Task<List<User>> GetUserList()
        => await _dbContext.User.FromSqlRaw(
            "EXEC dbo.SP_GetUsers"
        ).ToListAsync();

    public async Task<InsertUpdateUserRes> InsertUpdateUserReq(InsertUpdateUserReq model)
    {
        var parameters = new[]
        {
            new SqlParameter("@UserID", DbValue(model.UserID)),
            new SqlParameter("@UserRoleIDs", DbString(model.UserRoleIDs)),
            new SqlParameter("@UserName", DbString(model.UserName)),
            new SqlParameter("@Email", DbString(model.Email)),
            new SqlParameter("@FirstName", DbString(model.FirstName)),
            new SqlParameter("@LastName", DbString(model.LastName)),
            new SqlParameter("@EmployeeID", DbString(model.EmployeeID)),
            new SqlParameter("@AffiliateID", DbValue(model.AffiliateID)),
            new SqlParameter("@StatusID", DbValue(model.StatusID)),
            new SqlParameter("@CreatedBy", DbString(model.CreatedBy)),
            new SqlParameter("@IsInsert", model.IsInsert)
        };

        var result = _dbContext.Database
            .SqlQueryRaw<string>(
                "EXEC dbo.SP_Insert_Update_AssignedUser " +
                "@UserID, @UserRoleIDs, @UserName, @Email, @FirstName, @LastName, " +
                "@EmployeeID, @AffiliateID, @StatusID, @CreatedBy, @IsInsert",
                parameters)
            .AsEnumerable()
            .FirstOrDefault();

        return new InsertUpdateUserRes
        {
            Message = result
        };
    }

    public async Task<string> DeactivateUserReq(DeactivateUserReq model)
    {
        var response = await _dbContext.Database.ExecuteSqlRawAsync(
            "EXEC dbo.SP_Update_User_IsActivated @UserID, @IsActivated, @UpdatedBy",
            new SqlParameter("@UserID", model.UserID),
            new SqlParameter("@IsActivated", model.IsActivated),
            new SqlParameter("@UpdatedBy", DbString(model.UpdatedBy))
        );

        return response == 0
            ? SabicConstants.RecordNotFoundMessage
            : SabicConstants.SuccessMessage;
    }

    public async Task<List<SearchUser>> GetSearchUserListFromAD(string searchText)
    {
        var searchUsers = new List<SearchUser>();

        if (string.IsNullOrWhiteSpace(searchText) || searchText.Trim().Length <= 3)
            return searchUsers;

        var text = searchText.Trim().ToLower();

        var users = await _commonDbContext.WS_TB_Employees_Info
            .Where(x =>
                (x.DomainLoginID ?? "").Replace("SABICCORP\\", "").ToLower().Contains(text) ||
                (x.Email ?? "").ToLower().Contains(text) ||
                (x.EmpName ?? "").ToLower().Contains(text))
            .ToListAsync();

        foreach (var item in users)
        {
            searchUsers.Add(new SearchUser
            {
                EmployeeID = Convert.ToString(item.EmpID),
                LoginName = item.DomainLoginID?.Replace("SABIC\\", "SABICCORP\\"),
                FirstName = item.FirstName,
                LastName = item.LastName,
                UserName = item.EmpName,
                Email = item.Email
            });
        }

        return searchUsers;
    }

    public async Task<List<Role>> GetRoleList()
        => await _dbContext.Roles.FromSqlRaw(
            "EXEC dbo.SP_GetRole"
        ).ToListAsync();

    public async Task<List<Affiliate>> GetAffiliateList()
        => await _dbContext.Affiliates.FromSqlRaw(
            "EXEC dbo.SP_GetAffiliateForUserManagement"
        ).ToListAsync();
}
