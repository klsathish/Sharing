using WCI_APIs.Utils;
using WCICore.Contract;
using WCICore.Model;

namespace WCI_APIs.Middlewares
{

    public class ApiLoggingMiddleware
    {
        private readonly RequestDelegate _next;
        private readonly IServiceScopeFactory _scopeFactory;


        public ApiLoggingMiddleware(RequestDelegate next, IServiceScopeFactory scopeFactory)
        {
            _next = next;
            _scopeFactory = scopeFactory;
        }

        public async Task InvokeAsync(HttpContext context)
        {
            var requestTime = DateTime.Now;

            context.Request.EnableBuffering();
            string requestBody = "";
            using (var reader = new StreamReader(context.Request.Body, leaveOpen: true))
            {
                requestBody = await reader.ReadToEndAsync();
                context.Request.Body.Position = 0;
            }

            var originalBodyStream = context.Response.Body;
            using var responseBodyStream = new MemoryStream();
            context.Response.Body = responseBodyStream;

            await _next(context);

            var responseTime = DateTime.Now;

            context.Response.Body.Seek(0, SeekOrigin.Begin);
            var responseBody = await new StreamReader(context.Response.Body).ReadToEndAsync();
            context.Response.Body.Seek(0, SeekOrigin.Begin);

            await responseBodyStream.CopyToAsync(originalBodyStream);

            var loginSession = CommonUtils.GetCurrentSession(context);

            var model = new ApiRequestAndPerformanceLogModel();

            if (!string.IsNullOrEmpty(loginSession) && loginSession.Contains(":"))
            {
                var inpSes = loginSession.Split(':');

                model.UserID = int.TryParse(inpSes[0], out var uid) ? uid : 0;
                model.SessionID = inpSes[1];
                model.RoleID = int.TryParse(inpSes[2], out var rid) ? rid : 0;
                model.EmployeeName = inpSes[3];
                model.CreatedBy = inpSes[3];
            }

            model.CreatedOn = DateTime.Now;
            model.Duration = (responseTime - requestTime).TotalMilliseconds + " ms";
            var action = context.Request.RouteValues["action"]?.ToString();
            var path = context.Request.Path.ToString();
            var cleanPath = path.Replace($"/{action}", "", StringComparison.InvariantCultureIgnoreCase);

            var apiReq = new ApiRequestAndPerformanceLogRequest
            {
                ApiEndPoint = context.Request.Path,
                HttpMethod = context.Request.Method,
                StatusCode = context.Response.StatusCode,
                RequestBody = requestBody,
                RequestTimeStamp = requestTime,
                ResponseTimeStamp = responseTime,
                ResponseBody = responseBody,
                ComponentName = context.Request.Scheme + "://" + context.Request.Host + cleanPath,
                ActionName = context.Request.Path,
                LayerID = (int)Layer.Service
            };
            if (model.UserID > 0)
            {
                using (var scope = _scopeFactory.CreateScope())
                {
                    var apiRequestLogService = scope.ServiceProvider.GetService<IAPIRequestLogService>();
                    await apiRequestLogService!.InsertAPIRequestLogsAndPerformanceLogs(apiReq, model);
                }
            }
        }
    }

}
