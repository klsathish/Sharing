using Microsoft.EntityFrameworkCore.Metadata.Internal;
using WCI_APIs.Utils;
using WCICore.Contract;
using WCICore.Contract.Services;
using WCIInfrastructure.Service;

namespace WCI_APIs.Middlewares
{
    public class RoleAuthorizationMiddleware
    {
        private readonly RequestDelegate _next;
        private readonly IServiceScopeFactory _scopeFactory;
        private readonly IConfiguration _configuration;


        public RoleAuthorizationMiddleware(RequestDelegate next, IServiceScopeFactory scopeFactory, IConfiguration configuration)
        {
            _next = next;
            _scopeFactory = scopeFactory;
            _configuration = configuration;
        }

        public async Task InvokeAsync(HttpContext context)
        {
            var api = context.Request.Path.ToString().ToLower();
            //api = api.Split("/").Last();
            var pageUrls = new List<string>();
            var AcceptedUrls = new List<string> { "Login" };


            // Skip login / swagger / health check etc.
            if (api.Contains("login") || api.StartsWith("/swagger"))
            {
                await _next(context);
                return;
            }

          
            // ===== Read Session =====
            var loginSession = CommonUtils.GetCurrentSession(context);

            int roleId = 0;

            if (!string.IsNullOrEmpty(loginSession) && loginSession.Contains(":"))
            {
                var ses = loginSession.Split(':');

                // ses[2] = RoleId
                int.TryParse(ses[2], out roleId);
            }

            // If role not resolved -> not authorized
            if (roleId == 0)
            {
                context.Response.StatusCode = StatusCodes.Status401Unauthorized;
                await context.Response.WriteAsync("Role missing or invalid");
                return;
            }


            using (var scope = _scopeFactory.CreateScope())
            {
                var accountService = scope.ServiceProvider.GetService<IAccountService>();

                // ===== Call Stored Procedure =====
                var result = await accountService!.IsAuthorizedRoleApi(roleId, api);

                var isAllowed = result.HasAccess;

                if (!isAllowed)
                {
                    context.Response.StatusCode = StatusCodes.Status403Forbidden;
                    await context.Response.WriteAsync("Access Denied: the requested page is restricted for your role");
                    return;
                }
            }

            await _next(context);


        }

    }
}
