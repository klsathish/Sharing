using Microsoft.Data.SqlClient;
using System.Security.Claims;
using System.Text;
using System.Text.Json;
using WCICore.Common;

namespace WCI_APIs.Utils
{
    public class CommonUtils
    {
        public static string GetCurrentSession(HttpContext context)
        {
            var claims = context.User.Identity as ClaimsIdentity;
            Claim? claimUID = claims!.Claims.FirstOrDefault(claim => claim.Type == "uid");
            var userId = claimUID != null ? claimUID.Value : CommonMethod.GetUserName(context.User.Claims);
            Claim? JTI = claims!.Claims.FirstOrDefault(claim => claim.Type == "jti");
            var sessionId = JTI == null ? "" : JTI.Value.ToString();
            Claim? claimRID = claims!.Claims.FirstOrDefault(claim => claim.Type == "rid");
            var roleId = claimRID != null ? claimRID.Value : "";
            Claim? claimDomainLoginID = claims!.Claims.FirstOrDefault(claim => claim.Type == "domainLoginID");
            var userName = claimDomainLoginID != null ? claimDomainLoginID.Value : "";

            return userId + ":" + sessionId + ":" + roleId + ":" + userName;
        }
       
        public static string GetStatusFromException(Exception ex)
        {
            return ex switch
            {
                ArgumentException => "Validation Error",
                UnauthorizedAccessException => "Unauthorized",
                SqlException => "DataBase Error",
                TimeoutException => "Timeout Error",
                NotImplementedException => "Feature Not Implement",
                NullReferenceException => "Object Reference Not Set",
                InvalidOperationException => "Invalid Operation",
                IOException => "File I/O Error",
                _ => "Unhandle Exception"
            };
        }


        public static string GetRequestParameters(HttpContext context)
        {
            var parameters = new Dictionary<string, object>();
            foreach (var (key, value) in context.Request.Query)
            {
                parameters[$"{key}"] = value;
            }
            if (context.Request.HasFormContentType)
            {
                foreach (var (key, value) in context.Request.Form)
                {
                    parameters[$"{key}"] = value;
                }
            }
            return JsonSerializer.Serialize(parameters);
        }

        public async Task<string> ReadRequestBodyAsync(HttpRequest request)
        {
            try
            {
                request.Body.Seek(0, SeekOrigin.Begin);
                using var reader = new StreamReader(request.Body, leaveOpen: true);
                var body = await reader.ReadToEndAsync();
                request.Body.Seek(0, SeekOrigin.Begin);
                return body;
            }
            catch
            {
                return "[Could not read request body]";
            }
        }

        public async Task<string> ReadResponseBodyAsync(HttpResponse response)
        {
            if (response.Body == null)
                return string.Empty;

            response.Body.Seek(0, SeekOrigin.Begin);

            using var reader = new StreamReader(
                response.Body,
                Encoding.UTF8,
                detectEncodingFromByteOrderMarks: false,
                leaveOpen: true);

            var body = await reader.ReadToEndAsync();

            response.Body.Seek(0, SeekOrigin.Begin);

            return body;
        }


        public static int GetStatusCodeFromString(string stackTrace)
        {
            if (string.IsNullOrEmpty(stackTrace))
            {
                return 500;
            }
            else
            {
                if (stackTrace.Contains("Netword Error")) return 503;
                if (stackTrace.Contains("Unauthirized")) return 501;
                if (stackTrace.Contains("not found")) return 404;
                else return 500;

            }
        }
    }
}
